<!DOCTYPE html>
<html>

<head>
    <title>Ejemplo de Solicitud Fetch con jQuery</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        #modal-carga {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            /* Fondo semitransparente oscuro */
            z-index: 9999;
            text-align: center;
        }

        #cargando {
            width: 300px;
            height: 300px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* background: white; */
            padding: 20px;
            border-radius: 10px;
            /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); */
        }
    </style>
</head>

<body>
    <label for="fecha">Selecciona una fecha:</label>
    <input type="month" id="fecha" name="fecha">
    <label for="tiendas">Selecciona una tienda:</label>
    <select id="tiendas" name="tienda">
        <option value="181.48.190.38">VICTORIA'S SECRET MEDELLIN</option>
        <option value="190.144.104.46">VICTORIA'S SECRET JARDIN</option>
        <option value="190.85.103.188">VICTORIA'S SECRET CACIQUE</option>
        <option value="181.48.213.126">BATH & BODY WORKS BARRANQUILLA</option>
        <option value="181.48.212.38">VICTORIA'S SECRET BARRANQUILLA</option>
        <option value="181.48.129.126">VICTORIA'S SECRET TITAN</option>
    </select>
    <button id="obtenerFecha">Obtener Fecha</button>
    <div id="modal-carga" style="display: none;">
        <div id="cargando" style="display: none;">
            <i class="fas fa-circle-notch fa-spin fa-10x"></i>
            <p>Cargando...</p>
        </div>
    </div>
    <table id="tablaDatos" class="display">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Fecha</th>
                <th>Horario Entrada</th>
                <th>Horario Salida</th>
                <th>Horas trabajadas</th>
                <th>Horas extra</th>
                <th>Total de horas extra</th>
                <th>Total de horas</th>

            </tr>
        </thead>
        <tbody>
            <!-- Aquí debes agregar las filas de datos -->
        </tbody>
    </table>


    <!-- Agregar un botón de exportación a Excel -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-tableexport/1.3.0/js/tableExport.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script>
        // Hacer una solicitud Fetch a una API
        const obtenerFechaButton = document.getElementById('obtenerFecha');
        const fechaInput = document.getElementById('fecha');

        obtenerFechaButton.addEventListener('click', function () {
            document.getElementById('modal-carga').style.display = 'block';
            document.getElementById('cargando').style.display = 'block';
            const tiendas = document.getElementById('tiendas').value
            const fechaSeleccionada = fechaInput.value;
            $.ajax({
                url: `http://localhost:3000/users-by-registers?fecha=${fechaSeleccionada}&tienda=${tiendas}`,
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    let totalHoras = 0;
                    let totalHorasExtra = 0;
                    function formatHoraFromDateTime(dateTimeString) {
                        const dateTime = new Date(dateTimeString);
                        const hora = dateTime.getHours();
                        const minutos = dateTime.getMinutes();
                        const horaFormateada = `${hora.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
                        return horaFormateada;
                    }
                    function calcularDiferenciaHoras(registroInicio, registroFin) {
                        const horaInicio = new Date(registroInicio);
                        const horaFin = new Date(registroFin);
                        let diferenciaHoras = (horaFin - horaInicio) / (1000 * 60 * 60);
                        if (Math.abs(diferenciaHoras.toFixed(2)) !== 0) {
                            diferenciaHoras = diferenciaHoras - 1
                        }
                        let horasExtra = 0;

                        if (diferenciaHoras > 8) {
                            horasExtra = diferenciaHoras - 8;
                            totalHorasExtra += horasExtra
                        }
                        totalHoras += diferenciaHoras;
                        return { totalHoras: Math.abs(totalHoras.toFixed(2)), diferenciaHoras: Math.abs(diferenciaHoras.toFixed(2)), horasExtra };
                    }
                    const table = $('#tablaDatos').DataTable();

                    data.forEach(function (item) {
                        for (const fecha in item.registrosDia) {
                            const registros = item.registrosDia[fecha];

                            const horaLlegada = registros[0] ? registros[0].recordTime : '';
                            const horaSalida = registros[registros.length - 1] ? registros[registros.length - 1].recordTime : '';
                            // const diferenciaHoras = (new Date(registros[0].recordTime) - new Date(registros[registros.length - 1].recordTime)) / (1000 * 60 * 60);

                            const { diferenciaHoras, totalHoras, horasExtra } = calcularDiferenciaHoras(horaLlegada, horaSalida)

                            table.row.add([
                                item.userId,
                                item.name,
                                fecha,
                                formatHoraFromDateTime(horaLlegada),
                                formatHoraFromDateTime(horaSalida),
                                diferenciaHoras,
                                parseInt(horasExtra),
                                parseInt(totalHorasExtra),
                                totalHoras
                            ]).draw();
                        }

                        totalHorasExtra = 0
                        totalHoras = 0
                    });
                    // debugger
                    document.getElementById('modal-carga').style.display = 'none';
                    document.getElementById('cargando').style.display = 'none';
                    const newTable = table.DataTable();
                    newTable.buttons().container().appendTo('#tablaDatos_wrapper');


                },
                error: function () {
                    console.log('Error al cargar los datos de la API.');
                    document.getElementById('cargando').style.display = 'none';
                    document.getElementById('modal-carga').style.display = 'none';
                }
            });
        });



        // Agregar la funcionalidad de exportación al botón
        $('#export-button').on('click', function () {
            // Exportar la tabla a un archivo Excel
            $('#attendance-table').tableExport({ type: 'excel', escape: 'false' });
        });
        $(document).ready(function () {
            $('#tablaDatos').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copyHtml5',
                    'excelHtml5',
                    'csvHtml5',
                    'pdfHtml5'
                ]
            });
        });
    </script>
</body>

</html>